#################################################################
#								#
#	Créateur : Arthur YANG - Responsable Documentation 	#
#				 & Administratif		#
			
#	Date de création : 18/02/2025				#
#								#
#	Dernier modificateur : Arthur YANG			#
#	Date de modification : 18/02/2025			#
#								#
#		Version actuelle : 1.0				#
#								#
#################################################################


----------------------- Configuration et sécurisation du serveur de monitoring ----------------------- 

Sources : 


Actions effectuées dans le conteneur : 

   => Connexion via root / mot de passe
   => apt install unzip
   => Installation de l'agent promtail

	Installation de Promtail
  		 => Téléchargement et installation :
		On se place dans le chemin : /usr/local/bin/
		On télécharge le fichier zip de Promtail : wget https://github.com/grafana/loki/releases/download/v3.4.2/promtail-linux-amd64.zip
		Nous pouvons ensuite l'unzip : unzip (nom du fichier)
		C'est un fichier executable que l'on a.

	=> Configuration de Promtail :

	Nous devons ici, avoir un fichier nommé "promtail-config.yaml" pour la configuration de Promtail.
	Nous pouvons télécharger un modèle pré-existant : wget https://github.com/grafana/loki/blob/main/clients/cmd/promtail/promtail-local-config.yaml ou le créer nous même.
	Cela télécharge un modèle que l'on peut renommer comme nous le voulions.


=> Config .yaml personnalisé que nous effectuons :

--------------------------------------------------------------------------------------------

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /var/lib/promtail/positions.yaml

clients:
  - url: http://192.168.7.133:3100/loki/api/v1/push  # Utilisation de l'IP du serveur Loki

scrape_configs:
  - job_name: SRV-MONITORING-AARD-SYSLOG
    static_configs:
      - targets:
          - localhost
        labels:
          job: SYSLOG-AARD-MONITORING
          host: SRV-MONITORING-AARD
          stream: stdout
          __path__: /var/log/syslog

  - job_name: SRV-MONITORING-AARD-MAIL
    static_configs:
      - targets:
          - localhost
        labels:
          job: MAIL-AARD-MONITORING
          host: SRV-MONITORING-AARD
          stream: stdout
          __path__: /var/log/mail.log

  - job_name: SRV-MONITORING-AARD-AUTHLOG
    static_configs:
      - targets:
          - localhost
        labels:
          job: AUTHLOG-AARD-MONITORING
          host: SRV-MONITORING-AARD
          stream: stdout
          __path__: /var/log/auth.log

  - job_name: SRV-MONITORING-AARD-CRON
    static_configs:
      - targets:
          - localhost
        labels:
          job: CRON-AARD-MONITORING
          host: SRV-MONITORING-AARD
          stream: stdout
          __path__: /var/log/cron.log

--------------------------------------------------------------------------------------------


=> Créer un dossier /var/lib/promtail/ : mkdir -p /var/lib/promtail
		=> chown -R monitoring:monitoring /var/lib/promtail
		=> chmod -R 750 /var/lib/promtail

	=> Nous mettons l'utilisateur créée plus tôt "monitoring" en tant que propriétaire et propriétaire groupe des fichiers de config de Loki.
	
		=> chown -R monitoring:monitoring promtail-config.yaml promtail-linux-amd64
		=> chmod 755 promtail-linux-amd64
		=> chmod 640 promtail-config.yaml


	=> Création du fichier : /etc/systemd/system/promtail.service

--------------------------------------------------------------------------------------------

[Unit]
Description=Promtail Loki
Wants=network-online.target
After=network-online.target

[Service]
Type=simple
User=monitoring
Group=monitoring
ExecStart=/usr/local/bin/promtail-linux-amd64 -config.file=/usr/local/bin/promtail-config.yaml

SyslogIdentifier=monitoring
Restart=always

[Install]
WantedBy=multi-user.target

--------------------------------------------------------------------------------------------


Commandes système et visualisation des logs en direct :

		=> systemctl enable promtail.service 
		=> systemctl start promtail.service
		=> systemctl status promtail.service
		=> journalctl -f -u promtail.service

	Normalement le service promtail est lancé.


Dans nos conteneurs LXC Debian, les logs semblent être dans le "journald" et non le syslog.

On installe "rsyslog" pour qu'ils puissent etre visible dans "syslog"

	=> apt install rsyslog -y
	=> systemctl enable rsyslog --now
	=> tail -f /var/log/syslog

Pour que notre utilisateur "monitoring" puissent avoir les droits de lecture de logs, on va lui ajouter dans le groupe adm : 

	=> usermod -aG adm monitoring
	=> systemctl restart promtail.service

En effet, Un problèmes d’accès aux fichiers /var/log/auth.log, /var/log/cron.log et /var/log/user.log par Grafana sera présent par le fait que l'on a paramétré le service promtail avec l'utilisateur "monitoring".

Faire de même avec le fichier "syslog" : 

	=> chown monitoring:root /var/log/syslog
	=> chmod 640 /var/log/syslog
	=> systemctl restart promtail.service

On peut rajouter : 

	=> chown monitoring:utmp /var/log/btmp



De manière générale, regarder les permissions des fichiers selon l'utilisateur qui utilise le service.


Changement du port par défaut pour Grafana et accès web : port 3000 vers (Voir revue de sécurité)
	=> Faire le changement dans le fichier de configuration.


On va modifier quelques lignes pour la configuration des logs de grafana : 

	=> Dans le fichier /etc/grafana/grafana.ini

		=> # Directory where grafana can store logs
		   ;logs = /var/log/grafana

	=> On décommente (enlève le point virgule) la ligne ci-dessus

Puis on relance le service, et on peut observer l'enregistrement des logs dans le syslog.


On va config l'envoi des mails depuis grafana, dans le fichier /etc/grafana/grafana.ini : 
On utilise l'adresse : svg.wizardsndice@gmail.com et ne pas oublier de créer un mot de passe application

--------------------------------------------------------------------------------------------------------

################################### SMTP / Emailing ##########################
[smtp]
enabled = true
host = smtp.gmail.com:587
user = svg.wizardsndice@gmail.com
password = lfjz fdys rnha czul
;cert_file =
;key_file =
skip_verify = false
from_address = svg.wizardsndice@gmail.com
from_name = Grafana Monitoring
;ehlo_identity = dashboard.example.com
startTLS_policy = MandatoryStartTLS
# Enable trace propagation in e-mail headers, using the 'traceparent', 'tracestate' and (optionally) 'baggage' fields (defaults to false)
;enable_tracing = false

--------------------------------------------------------------------------------------------------------

La config est faite, on redemarre le service grafana.
Je créée les libellés sur la boite gmail pour les mails de grafana.
Les mails arrivent sur la boite mail.

Maintenant on peut config les alertes sur GRAFANA.
Voir sur grafana les alertes et leur config.


On va configurer LDAP pour Grafana, afin de pouvoir s'authentifier avec les id ldap.

	=> On créer le user pour link grafana et l'ad (grafanalink).
	=> On importe les certifs ldaps sur le srv monitoring (MDP : Meme que le compte "grafanalink" que j'ai mis pour ouvrir les certifs) => Dans /usr/local/share/ca-certificates/

Dans le fichier grafana.ini, on a la config suivante : 
On doit activer LDAP ici pour que sur le ui web LDAP apparaisse.
-------------------------------------------------------------------------------------------

# The public facing domain name used to access grafana from a browser
domain = wnd.local

[auth.ldap]
enabled = true
config_file = /etc/grafana/ldap.toml
allow_sign_up = true
# prevent synchronizing ldap users organization roles
skip_org_role_sync = false

--------------------------------------------------------------------------------------------


On peut restart le service, mais pour réellement config LDAPS sur le grafana, tout se passe dans le fichier : /etc/grafana/ldap.toml

-------------------------------------------------------------------------------------------

# To troubleshoot and get more log info enable ldap debug logging in grafana.ini
# [log]
# filters = ldap:debug

[[servers]]
# Ldap server host (specify multiple hosts space separated)
host = "SRV-DC-AARD.wnd.local"
# Default port is 389 or 636 if use_ssl = true
port = 636
# Set to true if LDAP server should use an encrypted TLS connection (either with STARTTLS or LDAPS)
use_ssl = true
# If set to true, use LDAP with STARTTLS instead of LDAPS
start_tls = false
# The value of an accepted TLS cipher. By default, this value is empty. Example value: ["TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384"])
# For a complete list of supported ciphers and TLS versions, refer to: https://go.dev/src/crypto/tls/cipher_suites.go
# Starting with Grafana v11.0 only ciphers with ECDHE support are accepted for TLS 1.2 connections.
tls_ciphers = []
# This is the minimum TLS version allowed. By default, this value is empty. Accepted values are: TLS1.1 (only for Grafana v10.4 or older), TLS1.2, TLS1.3.
min_tls_version = ""
# set to true if you want to skip ssl cert validation
ssl_skip_verify = false
# set to the path to your root CA certificate or leave unset to use system defaults
root_ca_cert = "/usr/local/share/ca-certificates/cert_intermediate.crt"
# Authentication against LDAP servers requiring client certificates
# client_cert = "/path/to/client.crt"
# client_key = "/path/to/client.key"

# Search user bind dn
bind_dn = "cn=Grafana Link,ou=Utilisateurs,ou=WND,dc=wnd,dc=local"
# Search user bind password
# If the password contains # or ; you have to wrap it with triple quotes. Ex """#password;"""
# We recommend using variable expansion for the bind_password, for more info https://grafana.com/docs/grafana/latest/setup-grafana/configure-grafana/#var>
bind_password = '$__env{LDAP_BIND_PASSWORD}'

# Timeout in seconds (applies to each host specified in the 'host' entry (space separated))
timeout = 10

# User search filter, for example "(cn=%s)" or "(sAMAccountName=%s)" or "(uid=%s)"
search_filter = "(sAMAccountName=%s)"

# An array of base dns to search through
search_base_dns = ["dc=wnd,dc=local"]

## For Posix or LDAP setups that does not support member_of attribute you can define the below settings
## Please check grafana LDAP docs for examples
#group_search_filter = "(&(objectClass=group)(member=%s))"
#group_search_base_dns = ["dc=wnd,dc=local"]
#group_search_filter_user_attribute = "distinguishedName"

# Specify names of the ldap attributes your ldap uses
[servers.attributes]
name = "givenName"
surname = "sn"
username = "sAMAccountName"
member_of = "memberOf"
email = "UserPrincipalName"

# Map ldap groups to grafana org roles
[[servers.group_mappings]]
group_dn = "cn=GL_Admins,ou=Services,ou=Groupes,ou=WND,dc=wnd,dc=local"
org_role = "Admin"
# To make user an instance admin  (Grafana Admin) uncomment line below
grafana_admin = true
# The Grafana organization database id, optional, if left out the default org (id 1) will be used
# org_id = 1

[[servers.group_mappings]]
group_dn = "cn=GL_Admins,ou=Services,ou=Groupes,ou=WND,dc=wnd,dc=local"
org_role = "Editor"

#[[servers.group_mappings]]
# If you want to match all (or no ldap groups) then you can use wildcard
#group_dn = "*"
#org_role = "Viewer"

-------------------------------------------------------------------------------------------

Sur le web ui, on essaye de config LDAPS : 

	=> On voit que c'est connecté sur le port 636 depuis le srv moni au srv dc
	=> Le test ne marche pas, mais j'arrive a me connecter avec mon compte "arthury", 

Maintenant je config dans le fichier /etc/grafana/ldap.toml
	=> Le fait d'attribuer les bon groupes aux personnes, cacher le mdp dedans etc.. , en gros de la config
	=> Les groupes sont fait, mais qu'avec un GL et non DL

Il faut que l'on cache le mot de passe qui lie le serveur DC avec le serveur monitoring, car dans la conf : /etc/grafana/ldap.toml, on voit qu'il est en clair (Le compte "grafana link" en gros).

On va donc créer une unité systemd avec variable cachée dans le fichier "override" du service GRAFANA.

	=> mkdir -p /etc/systemd/system/grafana-server.service.d
	=> nano /etc/systemd/system/grafana-server.service.d/override.conf

Puis on colle ceci dans le fichier :

	=> [Service]
	   Environment="LDAP_BIND_PASSWORD=MDP"

	=> On sauvegarde et quitte (Ctrl+O, Entrée, Ctrl+X)
	=> On change les droits pour plus de sécurité : chmod root:root 600 /etc/systemd/system/grafana-server.service.d/override.conf


On recharge systemd + restart Grafana

	=> systemctl daemon-reexec
	=> systemctl restart grafana-server


On peut vérifier que tout est bon :

	=> systemctl show grafana-server | grep LDAP_BIND_PASSWORD


On doit voir : Environment=LDAP_BIND_PASSWORD=MDP


Et dans ldap.toml, on doit bien avoir :

	=> bind_password = '$__env{LDAP_BIND_PASSWORD}'

On peut restart encore une fois les services, mais maintenant on plus le MDP en clair dans le fichier CONF de LDAP venant de GRAFANA.
Le LDAPS doit fonctionner en se connectant avec les comptes ADMINS.


On va avant de faire les dashboards, installer Prometheus. Cela nous permettra de récupérer des métriques sur le Stormshield par exemple, et voir quelques autres serveurs.

	=> Pour rester simple, on continuera d'utiliser l'utilisateur général "monitoring" créer exprès pour ce serveur. Pas besoin de créer un user pour Prometheus exclusivement.
	
	=> Créer un dossier /var/lib/prometheus : mkdir -p /var/lib/prometheus
		=> chown -R monitoring:monitoring /var/lib/prometheus
		=> chmod -R 750 /var/lib/prometheus
		
		=> mkdir /etc/prometheus
		=> chown -R monitoring /etc/prometheus
		=> chmod -R 750 /etc/prometheus

	=> Installation de Prometheus

  		=> Téléchargement et installation :
		On se place dans le chemin : /usr/local/bin/
		On télécharge le fichier zip de Prometheus : wget https://github.com/prometheus/prometheus/releases/download/v3.2.1/prometheus-3.2.1.linux-amd64.tar.gz
		Nous pouvons ensuite l'unzip : tar -xvf (nom du fichier)


	=> Configuration de Prometheus :

	Nous avons ici le répertoire Prometheus, on nous allons récupérer les applications "prometheus" et "promtool" dans /usr/local/bin

		=> mv prometheus-3.2.1.linux-amd64/prometheus /usr/local/bin/
		=> mv prometheus-3.2.1.linux-amd64/promtool /usr/local/bin/
	
	Puis le fichier "yaml" dans /etc/prometheus
	
		=> mv prometheus-3.2.1.linux-amd64/prometheus.yml /etc/prometheus

	On peut supprimer le repertoire "prometheus-3.2.1.linux-amd64"

		=> rm -r /usr/local/bin/prometheus-3.2.1.linux-amd64/

	On donne les bon droits pour tout les fichiers et répertoires : 

		=> chown -R monitoring:monitoring /usr/local/bin/prometheus /usr/local/bin/promtool
		=> chmod 755 /usr/local/bin/prometheus /usr/local/bin/promtool
		=> chmod 640 /etc/prometheus/prometheus.yml
		=> chown -R monitoring:monitoring /etc/prometheus/prometheus.yml


=> Création du fichier : nano /etc/systemd/system/prometheus.service

--------------------------------------------------------------------------------------------

[Unit]
Description=Prometheus Monitoring
Wants=network-online.target
After=network-online.target

[Service]
Type=simple
User=monitoring
Group=monitoring
ExecStart=/usr/local/bin/prometheus \
  --config.file=/etc/prometheus/prometheus.yml \
  --storage.tsdb.path=/var/lib/prometheus/

SyslogIdentifier=monitoring
Restart=always

[Install]
WantedBy=multi-user.target

--------------------------------------------------------------------------------------------


Commandes système et visualisation des logs en direct :

		=> systemctl daemon-reexec
		=> systemctl daemon-reload
		=> systemctl enable prometheus.service 
		=> systemctl start prometheus.service
		=> systemctl status prometheus.service
		=> journalctl -f -u prometheus.service

	Normalement le service prometheus est lancé.	

Prometheus est maintenant installé, il faut maintenant le config. Sur grafana ça fonctionne bien.

	=> On autorisera si besoin, l'écoute du port PROMETHEUS vers d'autres serveurs. Même si il n'y a pas besoin.
	=> Ce sera surtout les ports des "exporters" où il faudra autoriser sur le FW.
	=> Utilisation d'un port différent de celui par défaut. (Voir FW ou DOC de Sécu)


On va essayer de surveiller l'état du FW avec SNMP et Prometheus.

	=> On active SNMP sur FW (SNMPV2C) voir config sur le FW
	=> Autorisation du passage des infos snmp en autorisant le port SNMP et SNMPTRAP depuis le FW vers SRV MONITORING
	=> Sur le SRV MONITORING : apt install snmp
	=> On peut tester de récup des infos depuis le serveur via SNMP sur le FW : snmpwalk -v2c -c wnd -r 1 192.168.7.142



Pour configurer des DASHBOARDS ou utiliser grafana, une vidéo sera disponible en privé sur la chaine YT.